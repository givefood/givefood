{% extends "admin/page.html" %}

{% block title %}WhatsApp Tester - GF Admin{% endblock %}

{% block body %}

  <h2>WhatsApp Tester</h2>

  <div class="columns">

    <div class="column">

      <p>Send test WhatsApp notifications to individual subscribers. Sends the latest need for that subscription's food bank using the 'foodbankneed' message template.</p>

      <table class="table is-fullwidth is-hoverable">
        <tr>
          <th>ID</th>
          <th>Phone Number</th>
          <th>Foodbank</th>
          <th>Created</th>
          <th>Last Notified</th>
          <th></th>
        </tr>
        {% for subscription in subscriptions %}
          <tr{% if request.GET.sent == subscription.id|stringformat:"i" %} class="is-selected"{% endif %}>
            <td>{{ subscription.id }}</td>
            <td>{{ subscription.phone_number }}</td>
            <td><a href="{% url 'admin:foodbank' subscription.foodbank.slug %}">{{ subscription.foodbank.name }}</a></td>
            <td>{{ subscription.created }}</td>
            <td>{{ subscription.last_notified|default:"-" }}</td>
            <td>
              <form action="{% url 'admin:whatsapp_tester_send' %}" method="post">
                <input type="hidden" name="subscription_id" value="{{ subscription.id }}">
                <input type="submit" value="Send" onclick="return confirm('Are you sure? This will send a WhatsApp notification to {{ subscription.phone_number|escapejs }} with the latest need for {{ subscription.foodbank.name|escapejs }}.')" class="button is-primary is-small is-light">
                {% csrf_token %}
              </form>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6">No WhatsApp subscriptions found.</td>
          </tr>
        {% endfor %}
      </table>

    </div>

  </div>

{% endblock %}
